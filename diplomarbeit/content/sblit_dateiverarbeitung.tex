\subsection{Allgemein}
Ein wesentlicher Bestandteil von \sblit ist die Verarbeitung der Dateien. Dazu zählt das Erkennen von Änderungen und das Erkennen und Lösen von Konflikten.
\subsection{Logfile}\label{Logfile}
Ein wichtiges Mittel zur Verwaltung der Dateien ist das Logfile. Dieses enthält Informationen zu allen Dateien, die im \sblit-Ordner gespeichert sind. Dazu zählen der relative Dateipfad, eine Liste an Hashes, die für die Versionierung zuständig sind, und eine Liste an Geräten, auf denen die Datei bereits auf dem aktuellen Stand ist. Die Versionierung ist vor allem für die Konflikterkennung notwendig. Hierbei werden Hashes für jede Version aller Dateien gespeichert. Diese wird beim Speichern der Datei um den aktuellen Hashwert erweitert und bei Konvergenz auf allen Geräten auf die aktuelle gemeinsame Version reduziert. Informationen über die Konflikterkennung können im Kapitel \nameref{Konflikterkennung} auf der Seite \pageref{Konflikterkennung} in Erfahrung gebracht werden. \\
Damit \sblit weiß, wann die Dateien von den Partnergeräten \referenz{Partnergerät} wieder gelöscht werden können, wird die Liste mit den Geräten, auf denen die Datei auf dem aktuellen Stand ist, gespeichert. Die Liste wird bei jeder Änderung mit der Liste aller eigenen Geräte verglichen. Sobald hier alle eigenen Geräte eingetragen sind, werden die Partnergeräte dazu aufgefordert, die Datei zu löschen. 

\subsection{Reaktionen auf Dateiänderungen}
Wenn eine Datei neu erstellt, bearbeitet oder gelöscht wird, erkennt dies \sblit und kann diese Daten an den Synchronisationsprozess weiterleiten. Außerdem ist das Erkennen einer Änderung im \sblit-Ordner wichtig, da diese im Logfile protokolliert wird. Dieses wird sowohl für die Konflikterkennung \referenz{Konflikterkennung} als auch für eine Reduktion der benötigten Bandbreite \referenz{Dateianfrage} verwendet.\\
Um diese Änderungen zu erkennen, verwendet \sblit das sogenannte Watchservice. Das Watchservice ist eine Schnittstelle zum Dateisystem, welche vom Dateisystem benachrichtigt wird, wenn sich eine Datei in einem bestimmten Ordner ändert. In diesem Fall ist das der Ordner, der vom Benutzer für die Synchronisation festgelegt wurde. Je nach dem, ob eine Datei angelegt, verändert oder gelöscht wurde, passieren drei unterschiedliche Dinge. Wird eine Datei angelegt, werden eine neue Datei samt Hash in das Logfile geschrieben und eine Dateianfrage an die anderen, eigenen Geräte geschickt. Wird eine bereits vorhandene Datei verändert, werden ein neuer Hash zu den bereits vorhandenen Hashes hinzugefügt und ebenfalls eine Dateianfrage an die anderen eigenen Geräte gesendet. Wird die Datei gelöscht, wird diese samt Hashes aus dem Logfile gelöscht und eine Löschanfrage wird an die eigenen Geräte versendet.
 
\subsection{Konflikte}\label{Konflikt}
\subsubsection{Allgemein}
Ein Konflikt ist ein Problem, dass bei Synchronisationsdiensten vorkommt. Dieser tritt auf, wenn eine Datei bearbeitet wird, bevor diese synchronisiert werden kann. \\
Dazu ein Beispiel: Susanne hat einen Laptop und einen Stand-Rechner, auf denen sie mithilfe von \sblit einen Ordner synchronisiert. Im Normalfall, also wenn kein Konflikt auftritt, bearbeitet Susanne eine Datei auf dem Laptop. Nach dem Speichern wird die Datei auf den Stand-Rechner übertragen und dort gespeichert. Die Datei ist nun auf beiden Geräten synchron.\\
Angenommen, Susanne schaltet nun den Laptop aus. Später bearbeitet sie die Datei noch einmal auf dem Stand-Rechner. Da der Laptop ausgeschaltet ist, kann die Datei nicht synchronisiert werden. Auf dem Weg zur Arbeit fällt Susanne noch eine Verbesserungsmöglichkeit der Datei ein und sie bearbeitet die Datei auf dem Laptop ohne einer Verbindung zum Internet. In der Arbeit angekommen, packt Susanne wieder ihren Laptop aus und verbindet sich zum Internet. Die Datei kann jetzt nicht auf den neusten Stand gebracht werden, da ja zwei unterschiedliche Versionen existieren. Würde die Datei einfach vom Stand-Rechner auf den Laptop kopiert werden, gingen die Neuerungen am Laptop verloren, umgekehrt würde die Datei vom Laptop die Änderungen am Stand-Rechner überschreiben. Diesen Zustand zweier verschiedener Versionen ohne die jeweils anderen Änderungen nennt man einen Konflikt.
%TODO eventuell noch ergänzen

\subsubsection{Konflikterkennung}\label{Konflikterkennung}
Um Konflikte zu erkennen, verwendet \sblit eine interne Versionierung der Dateien. Diese wird im Kapitel "\nameref{Logfile}" auf der Seite \pageref{Logfile} näher erklärt. Bei einer Dateianfrage \referenz{Dateianfrage} werden alle Hashes einer Datei mitgesendet. Diese werden nach dem Empfang der Anfrage dann mit dem lokalen Logfile verglichen. Stimmen die beiden aktullen Hashes aus Dateianfrage und Logfile überein, muss die Datei gar nicht übertragen werden, da sie schon auf dem neusten Stand ist. Das heißt natürlich auch, dass kein Konflikt auftritt. Stimmt der aktuelle Hash im lokalen Logfile mit einem in der Dateianfrage überein, tritt ebenfalls kein Konflikt auf, da der aktuelle lokale Hash dem Gerät, dass die Anfrage verschickt hat, schon bekannt ist. \\
Ist der aktuelle Hash der lokalen Datei jedoch nicht in der Dateianfrage enthalten, wurde die lokale Datei bearbeitet, bevor diese auf den aktuellen Stand gebracht werden konnte. Anders gesagt: Ein Konflikt ist aufgetreten.

\subsubsection{Konfliktlösung}
Damit die Änderungen von einem Gerät nicht überschrieben werden, speichert \sblit beide Versionen. Da jedoch beide Dateien nicht den gleichen Namen haben können, benennt das Gerät, das den Konflikt erkennt, (im Folgenden Gerät A) die lokale Datei um. Anschließend schickt Gerät A eine Antwort an das Gerät, das die Dateianfrage geschickt hat,  (im Folgenden Gerät B) in der es die neue Version anfordert, als ob kein Konflikt aufgetreten wäre. Außerdem schickt Gerät A eine Dateianfrage mit der neuen Datei an Gerät B. Gerät B sendet nun die angeforderte Datei an Gerät A und akzeptiert die Konfliktdatei, da es eine Datei mit dem gleichen Namen noch nicht besitzt. \\
Nach dem Empfang der Datei speichtert Gerät A diese unter dem ursprünglichen Namen. Des Weiteren sendet Gerät A die Konfliktdatei mit dem geänderten Namen an Gerät B. Die neue Datei wird auf Gerät B unter dem neuen Namen gespeichert.

\subsubsection{Umsetzung}

Um Konflikte zu erkennen und zu lösen wird der folgende Code verwendet:
\javalisting
\begin{minipage}{\linewidth}
\begin{lstlisting}[caption={Erkennen eines Konflikts},captionpos=b]
private void handleConflict(LinkedList<Data> requestedHashes,
			LinkedList<Data> ownHashes, String path)
			throws IOException {
	String sblitDirectory = Configuration.getSblitDirectory()
			+ Configuration.slash;
	if (!requestedHashes.contains(ownHashes.get(ownHashes
			.size() - 1))) {
		int dotIndex = path.lastIndexOf(".");
		File conflictFile;
		if (dotIndex > path.lastIndexOf(Configuration.slash) 
				+ 1) {
			for (int i = 1;; i++) {
				conflictFile = new File(sblitDirectory
						+ path.substring(0, dotIndex)
						+ "(Conflict " + i + ")"
						+ path.substring(dotIndex));
				if (!conflictFile.exists()) {
					break;
				}
			}
		} else {
			for (int i = 1;; i++) {
				conflictFile = new File(sblitDirectory + path
						+ "(Conflict " + i + ")");
				if (!conflictFile.exists()) {
					break;
				}
			}
		}
		File file = new File(sblitDirectory + path);
		Files.copy(file.toPath(), conflictFile.toPath());
	}
}

\end{lstlisting}
\end{minipage}
\begin{description}
	\item[{requestedHashes:}] Der Parameter gibt an, welche Hashes in der Dateianfrage geschickt wurden. Die Hashes haben den Datentyp Data, welcher in \gls{dcl} definiert wurden. Um eine unbestimmte Menge davon speichern zu können, werden diese in eine LinkedList geschrieben. Diese hat den Vorteil, dass die Elemente die Reihenfolge behalten, in der sie in die Liste geschrieben wurden.
	
	\item[{ownHashes:}] Dieser Parameter enthält eine LinkedList an Hashes vom Datentyp Data, welche gemeinsam den Versionsverlauf der lokalen Datei ergeben. 
	
	\item[{path:}] Der Parameter path enthält den zum \sblit-Ordner relativen Pfad.
	
	\item[{sblitDirectory:}] Diese Variable vom Datentyp String enthält den absoluten Pfad des \sblit-Ordners. Dieser setzt sich zusammen aus \code{Configuration.getSblitDirectory()} und \code{Configuration.slash}. \code{Configuration.getSblitDirectory()} liefert den \sblit-Ordner zurück, der in der \code{Configuration}-Klasse definiert ist. Außerdem wird, je nach dem, ob das Betriebssystem Windows oder Unix-basierend ist, ein Backslash oder ein Slash an den Pfad gehängt. Die Zuweisung des richtigen Slashes wird am Programmstart bei der Initialisierung der \code{Configuration}-Klasse vorgenommen.

	\item[{dotIndex:}] In dieser Variable befindet sich der Index des letzten Punktes im Dateipfad. Dieser dient dazu, um herauszufinden, ob die Datei eine Endung hat.
	
	\item[{conflictFile:}] Das conflictFile ist die neue Datei, die erzeugt wird, wenn ein Konflikt auftritt.
	
	\item[{file:}] Die Variable file enthält die ursprüngliche Datei.
\end{description}
Mithilfe der \code{if}-Anweisung in Zeile sechs wird überprüft, ob der empfangene Versionsverlauf den letzten Hash, der im lokalen Logfile gespeichert ist, nicht enthält. Somit wird überprüft ob ein Konflikt aufgetreten ist. \\
In der \code{if}-Anweisung in Zeile 10 wird herausgefunden, ob die Datei eine Dateiendung besitzt. Dafür wird überprüft, ob der letzte Slash mehr als einen Platz vor dem Punkt ist, damit versteckte Dateien und Ordner unter Linux ausgeschlossen werden können. Diese werden nämlich mit einem Punkt vor dem Datei- oder Ordnernamen gekennzeichnet.\\
Die \code{for}-Schleife in Zeile 15 stellt zusammen mit der \code{if}-Anweisung in Zeile 21 sicher, dass die Konfliktdatei nicht schon vorhanden ist. Existiert diese noch nicht, wird die Schleife abgebrochen und der Name der Konfliktdatei bleibt erhalten.