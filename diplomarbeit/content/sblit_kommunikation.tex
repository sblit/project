\subsection{Allgemein}
Um zu verhindern, dass Daten mitgelesen werden, verwendet \sblit den sicheren \nameref{Applicationchannel} (siehe Seite \pageref{Applicationchannel}) der \gls{cl}.

Dabei unterscheidet man grundsätzlich zwischen Nachrichten, die an Partnergeräte \referenz{Partnergerät} und Nachrichten, die an die eigene Geräte geschickt werden. Weiters gibt es Nachrichten, die bei beiden Arten von Geräten gleich sind.

\subsection{Nachrichten an alle Geräte}
\subsubsection{Allgemein}
Bevor ein fremdes Gerät eine Verbindung aufbaut, muss auf jeden Fall seine Identität überprüft werden. Dabei werden folgende Nachrichten versendet:
\begin{itemize}
	\item \gls{authreq}s
	\item \gls{authres}s
\end{itemize}

\subsubsection{\gls{authreq}}
Sobald zwei Geräte (Gerät A, Gerät B) Daten austauschen wollen, müssen sie die Identität des jeweiligen Kommunikationspartners überprüfen. Dies erfolgt über \gls{authreq}s. Dabei schickt Gerät B zufällige Daten an Gerät A mit der Aufforderung, diese zu verschlüsseln \abbildung{authreq}. 
\messagestart
	\bitheader{0-7} \\
	
	\begin{rightwordgroup}{\isprotomsgtype}
		\wordbox[tlr]{1}{0}
	\end{rightwordgroup} \\
	
	\begin{rightwordgroup}{\isprotomsgdata}
		\wordbox[tblr]{4}{Zufallsdaten, 64 Bytes} 
	\end{rightwordgroup}
	
\messageend{authreq}
%TODO Umformulieren
Die Gesamtlänge der Daten, die mit RSA-2048 verschlüsselt werden, darf maximal 128 Byte betragen. Um zu verhindern, dass Gerät B bestimmte Daten mit dem Private-Key von Gerät A verschlüsseln lässt, werden 64 von den maximal 128 Byte reserviert. Diese 64 Byte nutzt Gerät A, um zufällige Daten hinzuzufügen.

\subsubsection{\gls{authres}}
Bevor die Daten wieder zurückgeschickt werden, müssen diese von Gerät A verschlüsselt werden. Dies geschieht mit dem Private-Key des Gerätes A. Dabei wird vorher noch ein zufälliger Wert an die empfangenen Daten angefügt.
\messagestart
	\bitheader{0-7} \\
	
	\begin{rightwordgroup}{\isprotomsgtype}
		\wordbox[tlr]{1}{1}
	\end{rightwordgroup} \\
	
	\begin{rightwordgroup}{\isprotomsgdata}
		\wordbox[tblr]{4}{Verschlüsselte Daten, 128 Bytes} 
	\end{rightwordgroup}
	
\messageend{authres}
Wird dieses Paket nun von Gerät B empfangen, kann der Inhalt mit dem Public-Key des Gerätes A, also dessen Adresse, entschlüsselt werden. Von den erhaltenen Daten werden die ersten 64 Byte mit den ursprünglich gesendeten 64 Byte verglichen. Stimmen die beiden Werte überein, kann das Gerät seine Authentizität beweisen. Stimmen diese jedoch nicht überein, handelt es sich um einen Betrüger, der offensichtlich den richtigen Private-Key zur von ihm angegebenen Adresse nicht kennt \abbildung{authres}.
		
\subsection{Nachrichten an eigene Geräte}
\subsubsection{Allgemein}
\sblitg verwendet zur Kommunikation zwischen den authentifizierten eigenen Geräten vier verschiedene Nachrichten:
\begin{itemize}
	\item \gls{filereq}s
	\item \gls{fileres}s
	\item \gls{filemsg}s
	\item \gls{filedel}s
	\item \gls{refdev}s
\end{itemize}

\subsubsection{\gls{filereq}} \label{Dateianfrage}
Bevor Gerät A eine Datei an Gerät B sendet, muss es zunächst eine Dateianfrage an Gerät B senden. Dies hat 2 Gründe: Einerseits muss eruiert werden, ob die Datei bereits auf Gerät B vorhanden ist und andererseits soll ein möglicher Konflikt \referenz{Konflikt} ausgeschlossen werden \abbildung{filereq}.
\messagestart
	\bitheader{0-7} \\
	
	\begin{rightwordgroup}{\isprotomsgtype}
		\wordbox[tlr]{1}{2}
	\end{rightwordgroup} \\
	
	\begin{rightwordgroup}{\isprotomsgdata}
		\wordbox[tlr]{2}{Dateipfad, variable Länge} \\
		\skippedwords \\
		\wordbox[lr]{1}{} \\
		\wordbox[tlr]{2}{Versionsverlauf, variable Länge} \\
		\skippedwords \\
		\wordbox[blr]{1}{}
	\end{rightwordgroup}
\messageend{filereq}

\begin{description} 
	\descriptionitem{Dateipfad}
		Hierbei wird der zu \sblit's Hauptordner relative Dateipfad mitgeschickt. Der absolute Dateipfad wird nicht mitgeschickt, da der Ort des \sblit-Ordners nicht auf allen Geräten gleich sein muss. Befindet sich der Ordner auf Gerät A beispielsweise unter \datei{C:/Users/Susanne/} kann sich der Ordner auf Gerät B auch unter \datei{/home/susanne/dateien/} befinden.
	\descriptionitem{Versionsverlauf}
		Der Versionsverlauf beinhaltet alle Hashes einer Datei seit der letzten komplett synchronisierten Version. Das heißt, dass auf jedem Gerät aktuell entweder diese oder eine neuere Version gespeichert ist.
\end{description}

		
\subsubsection{\gls{fileres}} \label{fileres}

\messagestart
	\bitheader{0-7} \\
	
	\begin{rightwordgroup}{\isprotomsgtype}
		\wordbox[tlr]{1}{3}
	\end{rightwordgroup} \\
	
	\begin{rightwordgroup}{\isprotomsgdata}
		\wordbox[tlr]{1}{Need-Flag, 1 Byte} \\
		\wordbox[tlr]{2}{Dateipfad, variable Länge} \\
		\skippedwords \\
		\wordbox[lr]{1}{} \\
		\wordbox[tlr]{2}{Hash, variable Länge} \\
		\skippedwords \\
		\wordbox[blr]{1}{}
	\end{rightwordgroup}
\messageend{fileres}

\begin{description}
	\descriptionitem{Need-Flag}
		Dieses Feld enthält einen Hexadezimalwert, der darüber Auskunft gibt, ob die Datei benötigt wird oder nicht. Steht in diesem Feld der Hexadezimalwert \code{0x00}, wird die Datei nicht benötigt, d.h. die aktuellste Version der Datei ist auf dem Gerät vorhanden. Steht hier hingegen der Hexadezimalwert \code{0x01}, wird die Datei benötigt. Dieses Byte hilft den Datenverkehr zu reduzieren. So muss nicht eine ganze Datei verschickt werden, obwohl diese gar nicht gebraucht wird.
	\descriptionitem{Dateipfad}
		Wie auch beim \gls{filereq} wird im \gls{fileres} der zu \sblit's Hauptordner relative Pfad mitgeschickt.
	\descriptionitem{Hash}
		Hier wird noch einmal der letzte Hash des Versionsverlaufs der Dateianfrage verschickt, um sicherzustellen, dass die Datei in der Zwischenzeit nicht geändert wurde. 
\end{description}
Nach Empfang der Dateianfrage wird zunächst geprüft, ob die Datei vorhanden und aktuell ist. Ist die lokale Datei nicht aktuell, wird das Need-Flag, auf den Hexadezimalwert \code{0x01} gesetzt. Ist die Datei auf dem aktuellsten Stand, wird es auf den Hexadezimalwert \code{0x00} gesetzt. Außerdem wird überprüft, ob ein Konflikt aufgetreten ist \referenz{Konflikterkennung}.

Nach Empfang der Antwort wird zunächst überprüft, ob der Hashwert der Datei mit dem erhaltenen Pfad übereinstimmt. Stimmt der Hashwert in der Anfrage nicht mit dem aktuellen Hashwert überein, wird die Antwort verworfen. Dies kann beispielsweise passieren, wenn in der Zwischenzeit eine neuere Version der Datei erzeugt wurde. Stimmt dieser jedoch überein, kann die Datei nun im nächsten Schritt verschickt werden.
		
\subsubsection{\gls{filemsg}}
Die \gls{filemsg} dient zur Übertragung der Datei \abbildung{filemsg}.
\messagestart
	\bitheader{0-7} \\
	
	\begin{rightwordgroup}{\isprotomsgtype}
		\wordbox[tlr]{1}{5}
	\end{rightwordgroup} \\
	
	\begin{rightwordgroup}{\isprotomsgdata}
		\wordbox[tlr]{2}{Dateiinhalt, variable Länge} \\
		\skippedwords \\
		\wordbox[lr]{1}{} \\
		\wordbox[tlr]{2}{Dateipfad, variable Länge} \\
		\skippedwords \\
		\wordbox[lr]{1}{} \\
		\wordbox[tlr]{2}{Versionsverlauf, variable Länge} \\
		\skippedwords \\
		\wordbox[lr]{1}{} \\
		\wordbox[tlr]{2}{Geräte mit der aktuellen Verision, variable Länge} \\
		\skippedwords \\
		\wordbox[blr]{1}{}
	\end{rightwordgroup}
	
\messageend{filemsg}

\begin{description}
	\descriptionitem{Dateiinhalt}
		Der Dateiinhalt wird als binäres \code{Data}-Objekt verschickt.
	\descriptionitem{Geräte mit der aktuellen Version}
		Hier stehen die Adressen aller Geräte, die schon die neuste Version schon haben. Ist die Version auf allen Geräten aktuell, kann sie von den Partnergeräten gelöscht werden. Daher wird diese Liste an Geräten immer mit der Datei mitgeschickt. Außerdem können somit unnötige Anfragen an Geräte, die die Datei schon besitzen, verhindert werden.
	\descriptionitem{Dateipfad}
		Der Dateipfad wird benötigt, damit das Gerät weiß, an welchem Ort die zu synchronisierende Datei gespeichert werden soll. Dies ist der gleiche relative Ort, wie auf dem Gerät, das die Anfrage geschickt hat.
	\descriptionitem{Versionsverlauf}
		Der Versionsverlauf wird mitgeschickt, damit er auf allen Geräten einheitlich ist. Dies verhindert, dass Konflikte fälschlicherweise erkannt werden, wo keine vorhanden sind. Weiters stellt der aktuellste Hash sicher, dass die versendete Datei korrekt zugestellt wurde. Verhasht man die versandte Datei, muss das Ergebnis mit dem aktuellsten mitgesendeten Hash übereinstimmen. Andernfalls muss die Datei neu gesendet werden.
\end{description}
		
\subsubsection{\gls{filedel}}
\messagestart
	\bitheader{0-7} \\
	
	\begin{rightwordgroup}{\isprotomsgtype}
		\wordbox[tlr]{1}{5}
	\end{rightwordgroup} \\
	
	\begin{rightwordgroup}{\isprotomsgdata}
		\wordbox[tlr]{2}{Dateipfad, variable Länge} \\
		\skippedwords \\
		\wordbox[blr]{1}{} 
	\end{rightwordgroup}
	
\messageend{filedel}
Eine \gls{filedel} beinhaltet den Pfad zur zu löschenden Datei. Nach Empfang der \gls{filedel} wird die Datei gelöscht \abbildung{filedel}.

\subsubsection{\gls{refdev}}
Die \gls{refdev} dient zur Aktualisierung von Gerätelisten \abbildung{refdev}.
\messagestart
	\bitheader{0-7} \\
	
	\begin{rightwordgroup}{\isprotomsgtype}
		\wordbox[tlr]{1}{6}
	\end{rightwordgroup} \\
	
	\begin{rightwordgroup}{\isprotomsgdata}
		\wordbox[tlr]{1}{File-Flag, 1 Byte} \\
		\wordbox[tlr]{2}{Geräte, variable Länge} \\
		\skippedwords \\
		\wordbox[blr]{1}{} 
	\end{rightwordgroup} 
	
\messageend{refdev}
\begin{description}
	\descriptionitem{File-Flag}
	Das File-Flag gibt darüber Auskunft, ob es sich um die Datei für Partnergeräte oder die Datei für die eigenen Geräte handelt.
	\descriptionitem{Geräte}
	Hier stehen die Adressen aller Geräte, die in der im File-Flag angegebenen Datei vorhanden sind. Bei Adressen von Partnergeräten, werden nur jene mitgeschickt, die auch die eigenen Dateien speichern. Im Falle von eigenen Adressen handelt, werden außerdem die Namen der Geräte, die man in der Konfiguration angegeben hat, mitgeschickt.
\end{description}

\subsection{Nachrichten an Partnergeräte}
\begin{itemize}
	\item \gls{partfilereq}s
	\item \gls{partfileres}s
	\item \gls{partfilemsg}s
	\item \gls{partfiledel}s
	\item \gls{filedel}s
\end{itemize}

\subsubsection{\gls{partfilereq}} \label{partnerfilerequest}
Der \gls{partfilereq} dient, wie der \gls{filereq}, zum Versenden einer Dateianfrage \abbildung{partfilereq}.
\messagestart
	\begin{rightwordgroup}{\isprotomsgtype}
		\wordbox[tlr]{1}{7}
	\end{rightwordgroup} \\
	
	\begin{rightwordgroup}{\isprotomsgdata}
		\wordbox[tlr]{2}{Versionsverlauf, variable Länge} \\
		\skippedwords \\
		\wordbox[blr]{1}{}
	\end{rightwordgroup}
\messageend{partfilereq}
\begin{description}
	\descriptionitem{Versionsverlauf}
	Der Versionsverlauf wird, wie beim \gls{filereq} mitgeschickt, damit der Partner die Datei identifizieren kann. Dies verhindert, dass der Partner den Dateipfad kennt und somit auf den Inhalt der Datei schließen kann. Weiters kann aus diesem Versionsverlauf, der lediglich Hashes enthält, nicht auf den Inhalt der Datei geschlossen werden, da das Verhashen eine Einwegfunktion ist. 
\end{description}

\subsubsection{\gls{partfileres}}
Der \gls{partfileres} dient zum Antworten auf einen \gls{partfilereq} \abbildung{partfileres}.
\messagestart
	\begin{rightwordgroup}{\isprotomsgtype}
		\wordbox[tlr]{1}{8}
	\end{rightwordgroup} \\
	
	\begin{rightwordgroup}{\isprotomsgdata}
		\wordbox[tlr]{2}{Versionsverlauf, variable Länge} \\
		\skippedwords \\
		\wordbox[blr]{1}{}\\
		\wordbox[blr]{1}{Need-Flag}
	\end{rightwordgroup}
\messageend{partfileres}

\begin{description}
	\descriptionitem{Versionsverlauf}
	Da die Datei auf den Partnergeräten mithilfe des Versionsverlaufs identifiziert wird, muss dieser mitgeschickt werden, um Verwechslungen vorzubeugen.
	\descriptionitem{Need-Flag}
	Das Need-Flag im \gls{partfileres} ist äquivalent zum Need-Flag im \gls{fileres} \referenz{fileres}.
\end{description}

\subsubsection{\gls{partfilemsg}}
Die \gls{partfilemsg} dient zum Versenden einer Datei an Partnergeräte \referenz{Partnergerät} \abbildung{partfilemsg}.
\messagestart
	\begin{rightwordgroup}{\isprotomsgtype}
		\wordbox[tlr]{1}{9}
	\end{rightwordgroup}\\
	
	\begin{rightwordgroup}{\isprotomsgdata}
		\wordbox[tlr]{2}{Versionsverlauf, variable Länge} \\
		\skippedwords \\
		\wordbox[lr]{1}{} \\
		\wordbox[tlr]{2}{Dateiinhalt, variable Länge} \\
		\skippedwords \\
		\wordbox[lr]{1}{} \\
		\wordbox[tlr]{2}{Dateipfad, variable Länge} \\
		\skippedwords \\
		\wordbox[lr]{1}{} \\
		\wordbox[tlr]{2}{Geräte mit der aktuellen Verision, variable Länge} \\
		\skippedwords \\
		\wordbox[blr]{1}{}
	\end{rightwordgroup}
\messageend{partfilemsg}
\begin{description}
	\descriptionitem{Versionsverlauf}
	Da der Versionsverlauf zur Identifikation der Datei benötigt wird, wird er auch bei der \gls{partfilemsg} mitgeschickt. Gleichzeitig dient der letzte Hash im Versionsverlauf als Dateiname auf dem Partnergerät.
	\descriptionitem{Dateiinhalt}
	Um den Inhalt der Datei vor fremdem Zugriff zu schützen, wird er mit dem symmetrischen Schlüssel \referenz{symmetricKey} verschlüsselt. 
	\descriptionitem{Dateipfad}
	Der Dateipfad wird, wie auch beim \gls{partfilereq}, verschlüsselt übertragen. 
	\descriptionitem{Geräte mit der aktuellen Version}
	Hier stehen die Adressen aller Geräte, die schon die neuste Version schon haben. Ist die Version auf allen Geräten aktuell, kann sie von den Partnergeräten gelöscht werden. Daher wird diese Liste an Geräten immer mit der Datei mitgeschickt. Außerdem können somit unnötige Anfragen an Geräte, die die Datei schon besitzen, verhindert werden.
\end{description}

\subsubsection{\gls{partfiledel}}
Die \gls{partfiledel} dient, wie die \gls{filedel}, zum Löschen von Dateien auf den eigenen Geräten \abbildung{partfiledel}.
\messagestart
	\begin{rightwordgroup}{\isprotomsgtype}
		\wordbox[tlr]{1}{10}
	\end{rightwordgroup} \\
	
	\begin{rightwordgroup}{\isprotomsgdata}
		\wordbox[tlr]{2}{Dateipfad, variable Länge} \\
		\skippedwords \\
		\wordbox[blr]{1}{} \\
	\end{rightwordgroup}
\messageend{partfiledel}
\begin{description}
	\descriptionitem{Dateipfad}
	Das einzige Attribut der \gls{partfiledel} ist der verschlüsselte Dateipfad. Dieser wird eine Woche lang gespeichert und dann gelöscht.
\end{description}

\subsubsection{\gls{filedel}}
Um Platz auf den Partnergeräten zu sparen, werden die Dateien gelöscht, sobald diese auf allen eigenen Geräten verteilt sind. Dies wird mit der \gls{filedel} initiiert. In der \gls{filedel} zwischen Partnergerät und eigenem Gerät wird der Versionsverlauf statt dem Dateinamen angegeben \abbildung{filedel}.
\messagestart
	\begin{rightwordgroup}{\isprotomsgtype}
		\wordbox[tlr]{1}{11}
	\end{rightwordgroup}\\
	
	\begin{rightwordgroup}{\isprotomsgdata}
		\wordbox[tlr]{2}{Versionsverlauf, variable Länge} \\
		\skippedwords \\
		\wordbox[blr]{1}{}
	\end{rightwordgroup}
\messageend{filedel}
\begin{description}
	\descriptionitem{Versionsverlauf}
	Der Versionsverlauf gibt die Datei an, die vom Partnergerät gelöscht werden soll.
\end{description}